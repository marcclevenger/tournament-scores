<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Save Scores</title>
  <style>
    body {font-family:-apple-system,sans-serif;padding:40px;background:#f0f8ff;text-align:center;}
    h1 {font-size:30px;color:#1e40af;}
    button {font-size:24px;padding:20px;background:#1e40af;color:white;border:none;border-radius:12px;width:90%;margin-top:30px;}
    .ok {color:green;font-size:22px;font-weight:bold;margin-top:20px;}
  </style>
</head>
<body>
  <h1>NCPL Score Saver</h1>
  <p>Enter all scores on the main tracker page first,<br>then come here and tap the button.</p>
  <button onclick="save()">SAVE SCORES PERMANENTLY</button>
  <p id="msg"></p>

<script>
async function save() {
  let token = localStorage.getItem('token');
  if (!token) {
    token = prompt('GitHub token (only once):');
    if (!token) return;
    localStorage.setItem('token', token);
  }

  document.getElementById('msg').innerHTML = 'Reading scores…';

  // Open your main page and grab all 14 games' scores
  const tab = window.open('https://marcclevenger.github.io/tournament-scores/', '_blank');
  setTimeout(async () => {
    try {
      const scores = await tab.eval(`(() => {
        const s = [];
        for(let i=0; i<14; i++) {
          const a = document.getElementById('scoreA-'+i)?.value || '0';
          const b = document.getElementById('scoreB-'+i)?.value || '0';
          s.push(a + ',' + b);
        }
        return s.join(';');
      })()`);

      document.getElementById('msg').innerHTML = 'Saving to GitHub…';

      const info = await fetch('https://api.github.com/repos/marcclevenger/tournament-scores/contents/index.html')
        .then(r => r.json());

      let content = atob(info.content);
      const marker = '// PRELOADED_SCORES_HERE';
      if (!content.includes(marker)) {
        content = content.replace(
          'window.onload = () => {',
          `window.PRELOADED_SCORES="${scores}";\n  window.onload = () => {`
        );
        content = content.replace(
          'renderSchedule();',
          `if(window.PRELOADED_SCORES){const a=window.PRELOADED_SCORES.split(';');a.forEach((p,i)=>{const[v1,v2]=p.split(',');const e1=document.getElementById('scoreA-'+i);const e2=document.getElementById('scoreB-'+i);if(e1)e1.value=v1;if(e2)e2.value=v2;});updateStandings();}\n    renderSchedule();`
        );
      } else {
        content = content.replace(/window\.PRELOADED_SCORES="[^"]*"/, `window.PRELOADED_SCORES="${scores}"`);
      }

      const res = await fetch('https://api.github.com/repos/marcclevenger/tournament-scores/contents/index.html', {
        method: 'PUT',
        headers: {Authorization:'token '+token,'Content-Type':'application/json'},
        body: JSON.stringify({
          message: 'Scores saved – ' + new Date().toLocaleString(),
          content: btoa(unescape(encodeURIComponent(content))),
          sha: info.sha
        })
      });

      if (res.ok) {
        document.getElementById('msg').innerHTML = '<div class="ok">Scores saved forever!<br>Refresh main site in 30 seconds</div>';
      } else {
        document.getElementById('msg').textContent = 'Failed – wrong token?';
      }
    } catch(e) {
      document.getElementById('msg').textContent = 'Error: '+e.message;
    }
  }, 4000);
}
</script>
</body>
</html>
